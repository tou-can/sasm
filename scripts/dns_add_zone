#!/bin/bash

if [ "$(id -u)" != "0" ]; then
    echo "This script must be run as root."
    exit 1
fi

if [ "$#" -ne 1 ]; then
    echo "Usage: sudo dns_add_zone <zone>"
    exit 1
fi

ZONE=$1
ZONE_FILE="/etc/bind/zones/db.$ZONE.vic-menten.sasm.uclllabs.be"

echo $ZONE
echo $ZONE_FILE

if [ -f "$ZONE_FILE" ]; then
    echo "Zone file $ZONE_FILE already exists. Exiting."
    exit 1
fi

echo "Adding zone $ZONE.vic-menten.sasm.uclllabs.be..."

# Create the zone file
cat <<EOL > $ZONE_FILE
\$TTL    86400
@       IN      SOA     ns.vic-menten.sasm.uclllabs.be. root.vic-menten.sasm.uclllabs.be. (
                              2         ; Serial
                         604800         ; Refresh
                          86400         ; Retry
                        2419200         ; Expire
                         86400 )       ; Negative Cache TTL
;
@       IN      NS      ns.vic-menten.sasm.uclllabs.be.
EOL

echo "Zone file $ZONE_FILE created."

# Check if the zone is already in the configuration file
if ! grep -q "$ZONE.vic-menten.sasm.uclllabs.be" /etc/bind/named.conf.yoda-zones; then
    echo "Adding zone configuration to /etc/bind/named.conf.yoda-zones..."
    echo "zone \"$ZONE.vic-menten.sasm.uclllabs.be\" {" >> /etc/bind/named.conf.yoda-zones
    echo "    type master;" >> /etc/bind/named.conf.yoda-zones
    echo "    file \"$ZONE_FILE\";" >> /etc/bind/named.conf.yoda-zones
    echo "};" >> /etc/bind/named.conf.yoda-zones
else
    echo "Zone $ZONE.vic-menten.sasm.uclllabs.be already exists in /etc/bind/named.conf.yoda-zones."
fi

# Reload bind to apply changes
sudo systemctl reload bind9

echo "Zone $ZONE.vic-menten.sasm.uclllabs.be added successfully."
